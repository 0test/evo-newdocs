# evoBabel

Мультиязычные сайты для Evolution CMS

Автор: [webber12](https://github.com/webber12)

## Состав:

1. Папка `assets/snippets/evoBabel`, содержащая основной сниппет `snippet.evoBabel.php` (создание языковых версий) и необходимый для работы файл `evoBabel.class.php`
2. Сниппет `evoBabel` - для вывода результатов работы в ТВ ресурса
3. Сниппет `lang` - для выдачи перевода на нужном языке на сайте
4. Плагин `evoBabel` - для правильной отдачи 404 страницы, синхронизации значений выбранных ТВ, чтения в сессию актуальных переводов
5. Плагин `evoBabelPlaceholders` - для парсинга языковых плейсхолдеров парсинга языковых плейсхолдеров вида `[%Главная страница%]` вместо сниппета `[[lang? &a='Главная страница']]`
6. Модуль `lexicon` для evoBabel (файлы и текст модуля)

## Возможности:

1. создание неграниченного количества языковых версий сайта
   при этом каждая версия хранится в своем дереве, что не ограничивает нас никак
   т.е. структура сайта на разных языках может отличаться (в отличие от YAMS), нет проблем с плейсхолдерами, другими сниппетами и т.п.
2. ресурсы разных языковых версий связаны между собой - что позволяет при навигации переключаться на нужную языковую версию ресурса
3. Возможна синхронизация значений нужных ТВ параметров для разных версий ресурса (id нужных ТВ и id нужных шаблонов задается в настройках плагина evoBabel)
4. Переводы в отдельном модуле Lexicon без перезагрузки и сразу для всех языков. Есть фильтрация, возможность добавления и удаления нужного языка там же

## Установка:

Скачать архив со сниппетом.

Поместить в папку `assets/snippets/` соответствующие папки.

Создать шаблон `Язык` и запомнить его `id` - будем присваивать его каждой корневой папке языка.

Создать в корне сайта один (или несколько) папок для языков - например `RU`, `EN` и т.п. с шаблоном `Язык`. Алиасы данных папок будут алиасами языков (`ru`, `en`, `fr` и т.п.).

Пусть у нас основным языком будет `RU`, создать в папке `RU` главную страницу (задать ее стартовой для сайта в конфигурации Evo CMS).

ID данной страницы внести в поле `description` нашего ресурса `RU`, в поле `longtitle` ресурса `RU` вписать слово `Русский` - там будет содержаться название языка для вывода в переключалке языков.

Создать новый TV-параметр (назовем его `relation`, заголовок - `Языковые версии ресурса`) с типом ввода `Custom Input` и в поле возможные значения вписать код `@EVAL return $modx->runSnippet("evoBabel");` - `id` именно этого TV и нужно вносить в настройки модуля как id TV, используемого для хранения связей.

Прикрепить данный TV ко всем шаблонам кроме шаблона `Язык`.

Создать новый сниппет `evoBabel` и поместить в него код из соответствующего файла в папке `install`.

Создать новый сниппет `lang` и скопировать код из соответствующего файла в папке `install`.

Создать новый плагин `evoBabel`, скопировать код из соответствующего файла в папке `install`

В конфигурации плагина вставить

```
&synch_TV=ids TV для синхронизации;text; &synch_template=ids шаблонов для синхронизации;text; &config=Файл шаблонов;text;assets/snippets/evoBabel/config/config.php
```

и указать нужные id TV и шаблонов для синхронизации через запятую.

Системные события для плагина `OnPageNotFound`, `OnDocFormSave`, `OnBeforeEmptyTrash`, `OnEmptyTrash`, `OnWebPageInit`, `OnDocDuplicate` поставить.

Создать новый модуль `evoBabelLexicon` и поместить в него код из соответствующего файла в папке `install`.

На вкладке конфигурация в режиме редактирования модуля отмеить галочку `Включить общие параметры`.

В строку `конфигурация модуля` на той же вкладке `конфигурация` вставить

```
&lang_template_id=id шаблона языка;text; &rel_tv_id=id TV языковых связей;text; &currlang=язык по умолчанию;text;ru &show_panel=Показывать панель;text;1 &publish=Публиковать (0 - нет, 1 - да);text;0
```

и внести в появившееся поле нужный нам `id` шаблона языка, id TV для хранения языковых связей и название языка по умолчанию согласно алиасу корневой папки.

Сохранить модуль и опять открыть на редактирование.

После чего перейти на вкладку `Зависимости` и открыть ссылку `Управление зависимостями`. На открывшейся странице добавить к зависимостям плагин `evoBabel` и сниппеты `evoBabel`, `lang`.

Опять вернуться к редактированию созданных сниппетов `evoBabel`, `lang` и плагина `evoBabel`. На вкладке "Свойства" в выпадающием списке "Импортировать общие параметры модуля" выбрать название нашего модуля.

Создать плагин `evoBabelPlaceholder` (событие `OnParseDocument`) и поместить в него код из папки `install` для соответствующего плагина (данный плагин используется для установки языковых плейсхолдеров `[%плейсхолдер%]` вместо запуска сниппета `lang` и необязателен.

Настройка админки завершена.

Теперь в каждом ресурсе мы должны получить в панели "Языковые версии" название текущего языка и список доступных языков.

Если перевод уже создан - то будет кнопка "перейти", если еще нет - кнопка "создать".

## Использование на сайте

1. В нужном месте шаблона размещаем плейсхолдеры:

- `[+activeLang+]` - для отдельного вывода текущего языка
- `[+switchLang+]` - для вывода переключалки языков

2. Сами переводы в шаблонах и чанках получаем с помощью сниппета lang

```
[[lang? &a=`Главная страница`]]
```

выведет перевод слов `Главная страница` для текущего языка из его чанка.

## Использование в сниппетах

```
[[DocLister? &parents=`[[lang? &a=`Папка каталог`]]` ...другие параметры ..]]
```

если вы установили плагин `evoBabelPlaceholder` то вместо вызова

```
[[lang? &a=`Главная страница`]]
```

можно использовать языковой плейсхолдер `[%Главная страница%]`

## Предупреждения и ограничения:

- Модуль поставляется "как есть", перед установкой изучите инструкцию и сделайте дамп базы сайта
- При запуске модуля создается новая таблица "префикс_lexicon" в базе данных.

> Важно: если у вас на странице на главной вкладке только один tv-параметр и это параметр смены языков, то из-за особенностей evo cms единственный tv с типом ввода custom input не показывается.

Для решения данной проблемы просто создайте еще один произвольный `tv` например с именем `okLang` и типом текст, а затем скройте его.
