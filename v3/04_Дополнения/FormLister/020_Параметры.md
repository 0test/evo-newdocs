# Общие параметры

Эти параметры обрабатываются базовым классом `FormLister`.

В контроллерах некоторые общие параметры могут иметь другое назначение.

- [Настройки](#params)
- [Источники данных](#sourcers)
- [Элементы управления](#elems)
- [Обработка данных](#process)
- [Шаблоны](#templates)
- [Перенаправление после обработки](#afterprocess)

## <a name="params"></a> Настройки

| параметр                              | описание                      | умолч.       |
| ------------------------------------- | ----------------------------- | ------------ |
| [controller](#param_controller)       | класс обработки данных        | `Form`       |
| [dir](#param_dir)                     | папка с классом               | см. описание |
| [formid](#param_formid)               | имя формы                     |              |
| [formMethod](#param_formmethod)       | тип получения данных          | `post`       |
| [disableSubmit](#param_disablesubmit) | запрет отправки               | `0`          |
| [config](#param_config)               | загрузка параметров           |              |
| [api](#param_api)                     | как выводить данные           |              |
| [apiFormat](#param_apiformat)         | формат вывода в режиме `api`  | `json`       |
| [debug](#param_debug)                 | включить отладку              | `0`          |
| [saveObject](#param_saveobject)       | сохранить объект `FormLister` |              |
| [removeGpc](#param_removegpc)         | убрать экранирование          | 0            |

### <a name="param_controller"></a> controller

Задает класс для обработки данных.

_Значения:_ имя php-файла с классом без расширения.

_По умолчанию:_ `Form`.

### <a name="param_dir"></a> dir

Папка в которой находится класс контроллера.

_По умолчанию:_ `assets/snippets/FormLister/core/controller/`

### <a name="param_formid"></a> formid

Имя формы, обязательный параметр.

В шаблоне формы обязательно должно быть скрытое поле с именем `formid` и значением, указанным в параметре. Форма считается отправленной, если в массиве `$_REQUEST` присутствует ключ с именем параметра, а его значение соответствует значению параметра.

### <a name="param_formmethod"></a> formMethod

Определяет способ получения данных запроса:

- `post` - из массива `$_POST`;
- `get` - из массива `$_GET`;
- `request` - из массива `$_REQUEST`;
- результат вызова анонимной функции или метода класса.

_Значения:_ `post`, `get`, `request`, имя анонимной функции или метода класса.

_По умолчанию:_ `post`.

### <a name="param_disablesubmit"></a> disableSubmit

Запрещает отправку формы. Если значение параметра равно `1`, то форма не будет считаться отправленной.

_Значения:_ `0`, `1`.

_По умолчанию:_ `0`.

### <a name="param_config"></a> config

Загрузка параметров в формате json из файла.

_Значения:_ `имяфайла:папка`, несколько значений разделяются точкой с запятой.

#### Пример

- `myparams:core` - загрузить параметры из файла `assets/snippets/FormLister/config/core/myparams.json`;
- `myparams` - загрузить параметры из файла `assets/snippets/FormLister/config/custom/myparams.json`;
- `myparams:/assets/myfolder` - загрузить параметры из файла `assets/myfolder/myparams.json`.

_По умолчанию:_ нет значения.

### <a name="param_api"></a> api

Определяет, в каком виде будут выводиться данные.

_Значения:_

- `0` - только html;
- `1` - массив с данными формы;
- `2` - массив с данными формы и html;
- `3` - объект контроллера.

### <a name="param_apiformat"></a> apiFormat

Формат вывода данных для api-режимов `1` или `2`.

_Значения:_ `json`, `array`.

_По умолчанию:_ `json`.

### <a name="param_debug"></a> debug

Режим отладки. Вывод записывается в лог MODx.

_Значения:_ `0`, `1`.

_По умолчанию:_ `0`.

### <a name="param_saveobject"></a> saveObject

Сохраняет объект класса `FormLister` в плейсхолдер, который можно использовать в других сниппетах. Объект сохраняется только при успешной обработке формы.

_Значения:_ имя плейсхолдера.

_По умолчанию:_ нет значения.

### <a name="param_removegpc"></a> removeGpc

Убирает экранирование данных, которое выполняет MODX для символов `{{`, `[[` и т.д. При этом экранируются тэги MODx при выводе.

_Значения:_ `0`, `1` или имена полей через запятую.

_По умолчанию:_ `0`.

## <a name="sources"></a> Источники данных

| параметр                                    | описание                                       | умолч. |
| ------------------------------------------- | ---------------------------------------------- | ------ |
| [defaultsSources](#param_defaultsources)    | загрузка доп.данных                            |        |
| [defaults](#param_defaults)                 | данные для источника array                     |        |
| [keepDefaults](#param_keepdefault)          | повторно загружать данные после отправки формы | `0`    |
| [allowEmptyFields](#param_allowemptyfields) | разрешает пустые значения полей                | `1`    |
| [fieldAliases](#param_fieldaliases)         | псевдонимы полей                               |        |

### <a name="param_defaultsources"></a> defaultsSources

Позволяет загружать дополнительные данные из внешних источников, например, для предварительного заполнения полей формы. По умолчанию внешние данные загружаются только при начальном выводе формы и не загружаются после отправки формы Это поведение может быть изменено с помощью параметра `keepDefaults`.

_Значения:_ список источников, разделенных точкой с запятой. Загрузка данных производится в том порядке, в котором они указаны в списке.

Источник может задаваться в формате `имя:ключ:префикс`.
Префикс, если указан, добавляется c точкой к имени поля - например, `config.site*name`. Если префикс заканчивается подчеркиванием (\*), то вместо точки будет использоваться подчеркивание (user_fullname), чтобы избежать преобразования точки в подчеркивание в PHP (https://www.php.net/manual/ru/language.variables.external.php).

_Значения:_

- `array` - json или php-массив, значения задаются параметром `defaults`;
- `param:имя`, `параметра:префикс` - значения задаются значением параметра из вызова сниппета (аналогично `array`, только значение задается не параметром `defaults`, а произвольным, также можно указать префикс);
- `session:ключи через запятую:префикс` - значения загружаются из массива `$_SESSION` согласно указанным ключам, значение может быть массивом;
- `plh:ключи через запятую:префикс` - загружаются значения из массива `$modx->placeholders` согласно указанным ключам, значение может быть массивом;
- `cookie:ключи через запятую:префикс` - загружаются значения из массива `$_COOKIE` согласно указанным ключам, значение может быть json-массивом;
- `config:префикс` - загружаются значения из конфигурации `MODx`;
- `имя класса MODxAPI:ключ:префикс` - ключ является аргументом метода `edit()`, класс должен быть заранее загружен;
- `document:префикс` - загружает данные из модели `modResource` для документа, в котором вызван сниппет. Ключ не указывается;
- `user:ключ:префикс` - загружает данные из модели `modUsers` для авторизованного пользователя. Тип пользователя уточняется в ключе (`web` или `mgr`).

_По умолчанию:_ `array`.

### <a name="param_default"></a> defaults

Данные для источника `array`.

_Значения:_ массив значений по умолчанию, в формате `json` или `php`.

### <a name="param_keepdefault"></a> keepDefaults

Позволяет повторно загружать данные из внешних источников после отправки формы. Если в параметре указан список полей, то загружены будут только указанные поля.

_Значения:_ `1`, `0`, имена полей, разделенные запятой.

_По умолчанию:_ `0`.

### <a name="param_allowemptyfields"></a> allowEmptyFields

Разрешает задавать поля с пустыми значениями.

_Значения:_ `0`, `1`.

_По умолчанию:_ `1`.

### <a name="param_fieldaliases"></a> fieldAliases

Задает псевдонимы полей. Например, для поля `foo` задан псевдоним `bar`:

```php
$FormLister->setField("foo", 10);
$FormLister->getField("bar"); // 10
$FormLister->setField("bar", 20);
$FormLister->getField("foo"); // 20
$FormLister->unsetField("foo");
$FormLister->getField("foo"); // нет значения
$FormLister->getField("bar"); // нет значения (но если бы было unsetField("foo", false), то поле "bar" осталось бы;
```

_Значения:_ массив вида:

```
&fieldAliases=`{
    "имя поле": "псевдоним",
    "имя поля": "псевдоним"
}
```

_По умолчанию:_ нет значения.

## <a name="elems"></a> Элементы управления

| параметр                                     | описание                               | умолч. |
| -------------------------------------------- | -------------------------------------- | ------ |
| [formControls](#param_formcontrols)          | список полей с управляющими элементами |        |
| [emptyFormControls](#param_emptyforcontrols) | решает проблему чекбоксов              |        |

### <a name="param_formcontrols"></a> formControls

Список полей с управляющими элементами формы (списки, чекбоксы, радио-кнопки). Необходимо для отслеживания состояния элементов.

_Значения:_ имена полей, разделенные запятой.

_По умолчанию:_ нет значения.

### <a name="param_emptyforcontrols"></a> emptyFormControls

Этот параметр позволяет решить проблему неотмеченных чекбоксов, которые не включаются в массив полей при отправке формы: если в `$_REQUEST` отсутствует нужный элемент, то он создается согласно данному параметру. Необходимость в таком параметре возникла в связи с тем, что MODxAPI требует явно указывать изменяемые поля в методе `fromArray()`. Но можно использовать и в обычных формах, чтобы подставить в шаблон значение неотмеченного чекбокса.

_Значения:_ массив:

```
&emptyFormControls=`{
    "mycheckbox": "Нет",
    "published": 0
}`
```

## <a name="process"></a> Обработка данных

| параметр                                          | описание                              | умолч. |
| ------------------------------------------------- | ------------------------------------- | ------ |
| [prepare](#param_prepare)                         | функции после загрузки данных в форму |        |
| [prepareProcess](#param_prepareprocess)           | функции после валидации               |        |
| [prepareAfterProcess](#param_prepareafterprocess) | функции после успешной обработки      |        |

### <a name="param_prepare"></a> prepare, <a name="param_prepareprocess"></a> prepareProcess, <a name="param_prepareafterprocess"></a> prepareAfterProcess

Аналогично параметру `prepare` в DocLister.

- Cниппеты из параметра `prepare` выполняются после загрузки данных в форму
- сниппеты из параметра `prepareProcess` - после прохождения валидации
- сниппеты из параметра `prepareAfterProcess` - после успешного выполнения обработки.

В сниппетах через переменную `$FormLister` доступен объект контроллера, а через массив `$data` - значения полей формы. Также доступна переменная `$name`, которая задержит имя параметра из которого взят сниппет (`prepare`, `prepareProcess` и т.д.); это позволяет использовать один и тот же сниппет для разных случаев. Для изменения данных следует использовать в prepare-сниппетах методы контроллера (`setField`, `setFields` и т.д.), но можно и просто вернуть массив с измененными данными.

_Значения:_ имена сниппетов, анонимные функции, статические методы загруженных классов.

_По умолчанию:_ нет значения.

## <a name="templates"></a> Шаблоны

| параметр                                                                                         | описание                                     | умолч.       |
| ------------------------------------------------------------------------------------------------ | -------------------------------------------- | ------------ |
| [formTpl](#param_formtpl)                                                                        | шаблон формы                                 |              |
| [arraySplitter](#param_arraysplitter)                                                            | разделитель в массиве                        | `;`          |
| [{field}.arraySplitter](#param_fieldarraysplitter)                                               | разделитель для одного поля                  |              |
| [errorTpl](#param_errortpl)                                                                      | шаблон сообщений валидатора                  | см. описание |
| [requiredClass](#param_requiredclass), [errorClass](#param_errorclass)                           | класс для `required` и `error` полей         |              |
| [{field}.requiredClass](#param_fieldrequiredclass), [{field}.errorClass](#param_fielderrorclass) | класс для одного поля `required` или `error` |              |
| [messagesTpl](#param_messagestpl)                                                                | шаблон сообщений обработчика формы           | см. описание |
| [messagesOuterTpl](#param_messagesoutertpl)                                                      | шаблон обёртка для группы сообщений          | см. описание |
| [messagesRequiredOuterTpl](#param_messagesrequiredoutertpl)                                      | шаблон обёртка для сообщений `required`      | см. описание |
| [messagesErrorOuterTpl](#param_messageserroroutertpl)                                            | шаблон обёртка для сообщений `error`         | см. описание |
| [messagesSplitter](#param_messagessplitter)                                                      | разделитель сообщений группы, общий          |              |
| [messagesRequiredSplitter](#param_messagesrequiredsplitter)                                      | разделитель сообщений группы `required`      |              |
| [messagesErrorSplitter](#param_messageserrorsplitter)                                            | разделитель сообщений группы `error`         |              |
| [removeEmptyPlaceholders](#param_removeemptyplaceholders)                                        | убирать незаполненные плейсхолдеры           | `1`          |
| [parseDocumentSource](#param_parsedocumentsource)                                                | обработать чанки парсером                    | `0`          |
| [rewriteUrls](#param_rewriteurls)                                                                | обработать ссылки в шаблонах                 | `0`          |
| [skipPrerender](#param_skipprepender)                                                            | отключить предобработку полей                | `0`          |
| [prerenderErrors](#param_prerendererrors)                                                        | выполнить обработку ошибок                   | `0`          |
| [templatePath](#param_templatepath), [templateExtension](#param_templateextension)               | путь к папке шаблонов                        |              |

### <a name="param_formtpl"></a> formTpl

Шаблон формы. В шаблоне формы обязательно должно быть поле с именем `formid` и значением, указанным в параметре `formid`.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ нет значения.

### <a name="param_arraysplitter"></a> arraySplitter

Разделитель для преобразования массивов в строку.

_По умолчанию:_ `;`.

### <a name="param_fieldarraysplitter"></a> {field}.arraySplitter

Разделитель для преобразования массивов в строку, но для отдельного поля `{field}`.

_Например:_ `groups.arraySplitter` - разделитель для массива из поля groups.

Если не задано, то используется значение параметра `arraySplitter`.

### <a name="param_errortpl"></a> errorTpl

Шаблон для вывода сообщений валидатора.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ `@CODE:<div class="error">[+message+]</div>`

### <a name="param_requiredclass"></a> requiredClass, <a name="param_errorclass"></a> errorClass

Имена классов для обозначения незаполненных `required` и неверно заполенных `error` полей.

_По умолчанию:_ `required` и `error` соответственно.

### <a name="param_fieldrequiredclass"></a> {field}.requiredClass, <a name="param_fielderrorclass"></a> {field}.errorClass

Позволяет задавать указанные выше классы для конкретных полей.

_По умолчанию:_ используются значения параметров `requiredClass` и `errorClass`.

### <a name="param_messagestpl"></a> messagesTpl

Шаблон сообщений обработчика формы. В шаблоне выводятся группы сообщений `messages`, `required`, `error`.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ `@CODE:<div class="form-messages">[+messages+]</div>`

### <a name="param_messagesoutertpl"></a> messagesOuterTpl

Шаблон-обертка для группы произвольных сообщений.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ `@CODE: [+messages+]`

### <a name="param_messagesrequiredoutertpl"></a> messagesRequiredOuterTpl

Шаблон-обертка для группы сообщений о незаполненных полях.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ `@CODE: [+messages+]`

### <a name="param_messageserroroutertpl"></a> messagesErrorOuterTpl

Шаблон-обертка для группы сообщений о неверно заполненных полях.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ `@CODE: [+messages+]`

### <a name="param_messagessplitter"></a> messagesSplitter, <a name="param_messagesrequiredsplitter"></a> messagesRequiredSplitter, <a name="param_messageserrorsplitter"></a> messagesErrorSplitter

Разделитель сообщений в группе.

_Значения:_ произвольная строка.

_По умолчанию:_ `<br>`

### <a name="param_removeemptyplaceholders"></a> removeEmptyPlaceholders

Удаляет из шаблонов незаполненные прейслхолдеры.

_Значения:_ `0`, `1`.

_По умолчанию:_ `1`.

### <a name="param_parsedocumentsource"></a> parseDocumentSource

Обрабатывает чанки MODx-парсером.

_Значения:_ `0`, `1`.

_По умолчанию:_ `0`.

### <a name="param_rewriteurls"></a> rewriteUrls

Если параметр `parseDocumentSource` отключен, то парсит ссылки в шаблонах.

_Значения:_ `0`, `1`.

_По умолчанию:_ `0`.

### <a name="param_skipprepender"></a> skipPrerender

Позволяет отключить предварительную обработку полей формы (экранирование значений, преобразование массивов в строки, установка сообщений об ошибках). Можно включить, если для вывода не используется парсер MODx.

_Значения:_ `0`, `1`.

_По умолчанию:_ `0`.

### <a name="param_prerendererrors"></a> prerenderErrors

При включенном параметре `skipPrerender` позволяет выполнить обработку только ошибок формы с сохранением результатов в массив плейсхолдеров. Для использования сторонних шаблонизаторов.

_Значения:_ `0`, `1`.

_По умолчанию:_ `0`.

### <a name="param_templatepath"></a> templatePath, <a name="param_templateextension"></a> templateExtension

Путь к папке с файлами шаблонов и расширение файлов шаблонов. Эти параметры необходимо задавать при использовании плагина EvoTwig.

_По умолчанию:_ нет значения.

## <a name="afterprocess"></a> Перенаправление после обработки

| параметр                        | описание                           | умолч. |
| ------------------------------- | ---------------------------------- | ------ |
| [redirectTo](#param_redirectto) | перенаправление на другую страницу |        |

### <a name="param_redirectto"></a> redirectTo

Id страницы, на которую нужно выполнить перенаправление после успешной обработки формы. В api-режиме перенаправление не выполняется, но в массиве данных формы сохраняется абсолютная ссылка на целевую страницу (поле `redirectTo`).

Вместо числа можно указывать массив:

```
&redirectTo=`{
    "page": 10,
    "query": {
        "foo": "bar"
    },
    "header": "HTTP/1.1 307 Temporary Redirect"
}`
```

Ключ page задает id станицы, в массиве query можно передать дополнительные get-параметры, значением ключа `header` может быть текст заголовка для перенаправления.

_Значения:_ число или массив.

_По умолчанию:_ нет значения.
