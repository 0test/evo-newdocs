# Регистрация пользователей

Контроллер `Register` позволяет регистрировать пользователей в заданные группы и отправлять уведомления о регистрации. Контроллер является расширением контроллера `Form`, соответственно можно использовать соответствующие параметры для отправки писем при регистрации.

Имена полей в форме должны соответствовать полям модели [modUsers](http://docs.evolution-cms.com/Extras/Snippets/DocLister/MODxAPI).

Если в форме не задано поле `username`, то ему присваивается значение поля `email`. Таким образом можно регистрировать пользователей только по `email`.

Если в форме не задано поле `password`, то значение поля генерируется автоматически. То есть регистрацию пользователя можно свести к указанию `email`.

При регистрации с паролем, в форме может присутствовать поле `repeatPassword`. Если заданы правила валидации для полей `password` и `repeatPassword`, то при наличии для поля `repeatPassword` правила `equals`, оно будет автоматически скорректировано для проверки равенства значений полей `password` и `repeatPassword`:

```
"repeatPassword": {
    "required": "Введите пароль еще раз",
    "equals": {
        "params": "Этот ключ в описании правила можно не задавать, он будет сформирован контроллером автоматически",
        "message": "Пароли не совпадают"
    }
}
```

При регистрации следует проверять уникальность имени пользователя и `email`. В контроллере предусмотрены соответствующие правила:

```
&rules=`{
    "username": {
        "required": "Введите имя пользователя",
        "alphaNumeric": "Только буквы и цифры",
        "custom": {
            "function": "\\FormLister\\Register::uniqueUsername",
            "message": "Имя уже занято"
        }
    },
    "email":{
        "required": "Введите email",
        "email": "Неверный email",
        "custom": {
            "function": "\\FormLister\\Register::uniqueEmail",
            "message": "Этот email уже использует другой пользователь"
        }
    }
}`
```

В шаблонах доступны все поля модели для созданной записи. Дополнительно задается поле `user.password` с незашифрованным паролем.

## Параметры

| параметр                                        | описание                                   | умолч.                            |
| ----------------------------------------------- | ------------------------------------------ | --------------------------------- |
| [model](#param_model)                           | имя класса                                 | `\modUsers`                       |
| [modelPath](#param_modelpath)                   | путь к файлу класса                        | `assets/lib/MODxAPI/modUsers.php` |
| [allowedFields](#param_allowedfields)           | разрешенные поля                           |                                   |
| [forbiddenFields](#param_forbiddenfields)       | запрещённые поля                           |                                   |
| [userGroups](#param_usergroups)                 | группы, куда добавить пользователя         |                                   |
| [checkActivation](#param_checkactivation)       | включить проверку активации                | `0`                               |
| [activateTo](#param_activateto)                 | страница со сниппетом активации            | `evo()->config['site_start']`     |
| [uidName](#param_uidname)                       | имя get-параметра для востановления пароля | см. описание                      |
| [preparePostProcess](#param_preparepostprocess) | доп. обработка после сохранения            |                                   |
| [redirectTo](#param_redirectto)                 | перенаправить после регистрации            |                                   |
| [exitTo](#param_exitto)                         | перенаправить уже авторизованного          |                                   |
| [skipTpl](#param_skiptpl)                       | шаблон сообщения для уже авторизованного   | `[+register.default_skipTpl+]`    |
| [successTpl](#param_successtpl)                 | шаблон сообщения об успешной регистрации   | `[+register.default_successTpl+]` |
| [passwordLength](#param_passwordlength)         | длина пароля                               | `6`                               |
| [dateFormat](#param_dateformat)                 | формат даты поля dob                       |                                   |

### <a name="param_model"></a> model

Класс для работы с пользователями.

_Значения:_ имя класса. Для Evo 3.x следует использовать модель `Pathologic\EvolutionCMS\MODxAPI\modUsers` из пакета `pathologic/modxapi`.

_По умолчанию:_ `\modUsers`

### <a name="param_modelpath"></a> modelPath

Путь к файлу класса для работы с пользователями.

_Значения:_ относительный путь к файлу.

_По умолчанию:_ `assets/lib/MODxAPI/modUsers.php`

### <a name="param_allowedfields"></a> allowedFields

Разрешенные для обработки поля. Поля, не указанные в списке, игнорируются. Поля `username`, `email` и `password` всегда разрешены.

Если не задано, то разрешены все поля.

_Значения:_ имена полей формы, разделенные запятой.

_По умолчанию:_ нет значения.

### <a name="param_forbiddenfields"></a> forbiddenFields

Запрещенные для обработки поля. Поля, указанные в списке, игнорируются. Поля `username`, `email` и `password` удаляются из списка запрещенных.

_Значения:_ имена полей формы, разделенные запятой.

_По умолчанию:_ нет значения.

### <a name="param_usergroups"></a> userGroups

Добавляет зарегистрированного пользователя в указанные группы.

_Значения:_ имена групп, разделенные запятой (если имена содержат запятую в названии, то можно задать значение параметра массивом).

_По умолчанию:_ нет значения.

### <a name="param_checkactivation"></a> checkActivation

Включает проверку активации учетной записи пользователя (см. "Активация учетных записей"). При этом после сохранения записи будет установлено поле `activate.url`, содержащее ссылку на страницу с вызовом сниппета для активации учетной записи.

_Значения:_ `1`, `0`.

_По умолчанию:_ `0`.

### <a name="param_activateto"></a> activateTo

Если включена проверка активации, то в этом параметре необходимо указать id страницы, на которой вызывается сниппет для активации.

_Значения:_ id страницы.

_По умолчанию:_ значение evo()->config['site_start'].

### <a name="param_uidname"></a> uidName

Имя GET-параметра в ссылке для восстановления пароля, который содержит id пользователя.

_По умолчанию:_ primary key для таблицы с пользователями.

### <a name="param_preparepostprocess"></a> preparePostProcess

Позволяет выполнить обработку данных после сохранения.

_Значения:_ имена сниппетов, анонимные функции, статические методы загруженных классов.

_По умолчанию:_ нет значения.

### <a name="param_redirectto"></a> redirectTo

Перенаправляет пользователя на указанную страницу после регистрации.

_Значения:_ id целевой страницы или массив.

_По умолчанию:_ нет значения.

### <a name="param_exitto"></a> exitTo

Перенаправляет уже авторизованного пользователя на указанную страницу.

_Значения:_ id целевой страницы.

_По умолчанию:_ нет значения.

### <a name="param_skiptpl"></a> skipTpl

Шаблон сообщения для уже авторизованного пользователя.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ запись из лексикона `Register` с ключом `[+register.default_skipTpl+]`

### <a name="param_successtpl"></a> successTpl

Шаблон сообщения об успешной регистрации.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ запись из лексикона `Register` с ключом `[+register.default_successTpl+]`

### <a name="param_passwordlength"></a> passwordLength

Длина пароля (если создается автоматически).

_Значения:_ число символов больше 6.

_По умолчанию:_ `6`.

### <a name="param_dateformat"></a> dateFormat

Формат даты для поля dob.

_Значения:_ формат даты по правилам функции date (например, `d.m.Y`).
