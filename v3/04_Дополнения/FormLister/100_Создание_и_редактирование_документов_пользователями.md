# Создание и редактирование документов пользователями

Контроллер `Content` позволяет web-пользователям создавать и редактировать записи в таблицах `MODxAPI`. Расширяет контроллер `Form`, что позволяет отправлять письма после создания записи. При редактировании записей отправка почты отключена, при необходимости ее можно реализовать с помощью плагинов на событие сохранения (`OnDocFormSave` и т.п.).

Данные формы передаются в объект `MODxAPI` как есть, соответственно разработчику нужно заботиться об их корректности самостоятельно.

При редактировании записей можно запретить изменение отдельных полей, используя параметр `keepDefaults`.

При создании новой записи вызывается событие `OnMakeDocUrl`, в которое передается `id` записи и массив `data` со значениями полей записи. Это позволяет вернуть ссылку на созданную запись, она будет доступна через плейсхолдер `[+content.url+]`. Ссылку можно использовать в письме c уведомлением о создании новой записи.

Также можно использовать данные авторизованного пользователя, доступны через плейсхолдеры `[+user.fullname+]`, `[+user.email+]` и т.д.

## Параметры

| параметр                                  | описание                                                               | умолч.                               |
| ----------------------------------------- | ---------------------------------------------------------------------- | ------------------------------------ |
| [model](#param_model)                     | имя класса                                                             | `\modResource`                       |
| [modelPath](#param_modelpath)             | путь к файлу класса                                                    | `assets/lib/MODxAPI/modResource.php` |
| [userModel](#param_usermodel)             | класс для работы с пользователями                                      | `\modUsers`                          |
| [userModelPath](#param_usermodelpath)     | путь к файлу класса для работы с пользователями                        | `assets/lib/MODxAPI/modUsers.php`    |
| [onlyUsers](#param_onlyusers)             | разрешить добавление только зарегистрированным                         | `1`                                  |
| [userGroups](#param_usergroups)           | группы, которым разрешено добавлять/изменять                           |                                      |
| [onlyOwners](#param_onlyowners)           | разрешить редактирование только авторам                                | `1`                                  |
| [ownerField](#param_ownerfield)           | имя поля, определяющее автора                                          | `aid` или `createdby`                |
| [idField](#param_idfield)                 | имя ключа из `$_REQUEST` с номером записи                              | `id`                                 |
| [contentFields](#param_contentfields)     | сопоставление полей modxapi и полей формы                              |                                      |
| [clearCache](#param_clearcache)           | очистить кеш после сохранения                                          | `0`                                  |
| [redirectTo](#param_redirectto)           | перенаправить после сохранения новой                                   |                                      |
| [editAfterCreate](#param_editaftercreate) | перенеправить на редактирование после создания                         | `0`                                  |
| [editTpl](#param_edittpl)                 | шаблон формы редактировани                                             | значение `formTpl`                   |
| [badOwnerTpl](#param_badownertpl)         | шаблон сообщения что пользователь не автор                             | `[+edit.default_badOwnerTpl+]`       |
| [badGroupTpl](#param_badgrouptpl)         | шаблон сообщения о том что пользователь не в группе                    | `[+create.default_badGroupTpl+]`     |
| [badGroupEditTpl](#param_badgroupedittpl) | шаблон сообщения о том что пользователь не в группе при редактировании | `[+edit.default_badGroupTpl+]`       |
| [badRecordTpl](#param_badrecordtpl)       | шаблон сообщения что пользователь не может редактировать               | `[+edit.default_badRecordTpl+]`      |
| [exitTo](#param_exitto)                   | перенаравить неавторизованного                                         |                                      |
| [skipTpl](#param_skiptpl)                 | шаблон сообщения для неавторизованного                                 | `[+create.default_skipTpl+]`         |
| [skipEditTpl](#param_skipedittpl)         | шаблон сообщения для неавторизованного при редактировании              | `[+edit.default_skipEditTpl+]`       |
| [successTpl](#param_successtpl)           | шаблон сообщения об успешном сохранении новой                          | `[+create.default_successTpl+]`      |
| [editSuccessTpl](#param_editsuccesstpl)   | шаблон сообщения об успешном обновлении                                |                                      |

### <a name="param_model"></a> model

Класс MODxAPI.

_Значения:_ имя класса MODxAPI.

_По умолчанию:_ `\modResource`.

### <a name="param_modelpath"></a> modelPath

Путь к файлу класса, если класс не загружается заранее.

_Значения:_ относительный путь к файлу.

_По умолчанию:_ `assets/lib/MODxAPI/modResource.php`.

### <a name="param_usermodel"></a> userModel

Класс для работы с пользователями.

_Значения:_ имя класса. Для Evo 3.x следует использовать модель `Pathologic\EvolutionCMS\MODxAPI\modUsers` из пакета `pathologic/modxapi`.

_По умолчанию:_ `\modUsers`

### <a name="param_usermodelpath"></a> userModelPath

Путь к файлу класса для работы с пользователями.

_Значения:_ относительный путь к файлу.

_По умолчанию:_ `assets/lib/MODxAPI/modUsers.php`

### <a name="param_onlyusers"></a> onlyUsers

Разрешить добавление записей только для зарегистрированных пользователей.

_Значения:_ `0`, `1`.

_По умолчанию:_ `1`.

### <a name="param_usergroups"></a> userGroups

Группы пользователей, которым разрешено добавлять или изменять записи.

_Значения:_ список групп через точку с запятой.

_По умолчанию:_ пусто (разрешены любые группы).

### <a name="param_onlyowners"></a> onlyOwners

Разрешает редактирование записей только их авторами. Автор определяется по полю, указанному в параметре `ownerField`.

_Значения:_ `0`, `1`.

_По умолчанию:_ `1`.

### <a name="param_ownerfield"></a> ownerField

Имя поля, определяющего владельца записи. Если работать с документами `modResource`, то это будет имя tv-параметра (в Evo не предусмотрено создание записей веб-пользователями).

_Значения:_ имя поля. Для Evo 3.x следует использовать `createdby`.

_По умолчанию:_ `aid`.

### <a name="param_idfield"></a> idField

Имя ключа массива `$_REQUEST`, по которому определяется `id` редактируемой записи. Если ключ не задан, то контроллер вызывается в режиме создания записей. Информацию о режиме контроллера можно получить с помощью метода `getMode`.

В форме редактирования нужно предусмотреть скрытое поле с именем параметра, в котором будет сохраняться id записи.

_По умолчанию:_ `id`.

### <a name="param_contentfields"></a> contentFields

Задает сопоставление полей `MODxAPI` и полей формы. Можно не задавать, если имена полей совпадают. Если параметр не задан, то ограничить список передаваемых в модель полей можно с помощью параметров `allowedFields` и `forbiddenFields`.

_Значения:_ массив вида:

```
&contentFields=`{
    "поле MODxAPI": "поле формы",
    "поле MODxAPI": "поле формы"
}
`
```

_По умолчанию:_ нет значения.

### <a name="param_clearcache"></a> clearCache

Очищать кэш после сохранения записи.

_Значения:_ `0`, `1`.

_По умолчанию:_ `0`.

### <a name="param_redirectto"></a> redirectTo

Перенаправляет пользователя на указанную страницу после сохранения новой записи. В режиме редактирования не используется.

_Значения:_ id целевой страницы или массив.

_По умолчанию:_ нет значения.

### <a name="param_editaftercreate"></a> editAfterCreate

Переправляет пользователя на страницу для редактирования созданной записи. Страница указывается в параметре `redirectTo`.

_Значения:_ `1`, `0`.

_По умолчанию:_ `0`.

### <a name="param_edittpl"></a> editTpl

Шаблон формы для редактирования документа.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ значение параметра `formTpl`.

### <a name="param_badownertpl"></a> badOwnerTpl

Шаблон сообщения о том, что пользователь не является автором документа. Только режим редактирования.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ запись из лексикона `Content` с ключом `[+edit.default_badOwnerTpl+]`.

### <a name="param_badgrouptpl"></a> badGroupTpl, <a name="param_badgroupedittpl"></a> badGroupEditTpl

Шаблон сообщения о том, что пользователь не входит в группу пользователей которым разрешено создавать и редактировать документы.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ запись из лексикона `Content` с ключом `[+create.default_badGroupTpl+]` или `[+edit.default_badGroupTpl+]`.

### <a name="param_badrecordtpl"></a> badRecordTpl

Шаблон сообщения о том, что пользователь не может редактировать запись: например, запись не существует. Только режим редактирования.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ запись из лексикона `Content` с ключом `[+edit.default_badRecordTpl+]`.

### <a name="param_exitto"></a> exitTo

Перенаправляет неавторизованного пользователя на указанную страницу.

_Значения:_ id целевой страницы или массив.

_По умолчанию:_ нет значения.

### <a name="param_skiptpl"></a> skipTpl, <a name="param_skipedittpl"></a> skipEditTpl

Шаблон сообщения для неавторизованного пользователя. Для режима редактирования - `skipEditTpl`.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ запись из лексикона `Content` с ключом `[+create.default_skipTpl+]`, `[+edit.default_skipEditTpl+]`.

### <a name="param_successtpl"></a> successTpl

Шаблон сообщения об успешном сохранении новой записи.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ запись из лексикона `Content` с ключом `[+create.default_successTpl+]`

### <a name="param_editsuccesstpl"></a> editSuccessTpl

Шаблон сообщения об успешном обновлении записи.

_Значения:_ имя шаблона, указанное по правилам задания шаблонов в DocLister.

_По умолчанию:_ нет значения.
