# Валидация данных

При валидации данных валидатор последовательно применяет к значению поля заданные правила, при возникновении ошибки в массив данных об ошибках добавляется запись и дальнейшая обработка формы прекращается.

Валидация считается пройденной, если в массиве данных об ошибках отсутствуют записи.

Содержание:

- [Валидация](#validator)
- [Правила валидации](#rules)
- [Валидация файлов](#files)
- [Результаты валидации](#results)

## <a name="validator"></a> Валидация

| параметр                              | описание                    | умолч.                      |
| ------------------------------------- | --------------------------- | --------------------------- |
| [validator](#param_validator)         | имя класса валидации        | `\FormLister\Validator`     |
| [rules](#param_rules)                 | правила валидации           |                             |
| [fileValidator](#param_filevalidator) | имя класса валидации файлов | `\FormLister\FileValidator` |
| [fileRules](#param_filerules)         | правила валидации           |                             |

### <a name="param_validator"></a> validator

Имя класса для валидации данных. Класс должен быть предварительно загружен.

_По умолчанию:_ `\FormLister\Validator`.

### <a name="param_rules"></a> rules

Массив с правилами валидации.

_По умолчанию:_ нет значения.

### <a name="param_filevalidator"></a> fileValidator

Имя класса для валидации файлов. Если задано, то класс должен быть загружен заранее.

_По умолчанию:_ `\FormLister\FileValidator`

### <a name="param_filerules"></a> fileRules

Массив с правилами валидации.

_По умолчанию:_ нет значения.

## <a name="rules"></a> Правила валидации

Список правил задается в виде массива. Ключом является имя поля, а значением - массив правил валидации. Правило валидации является методом класса-валидатора.

В массиве правил ключом является имя правила (название метода валидации), значением может быть либо строка с сообщением об ошибке валидации правила, или же массив с описанием.

В этом массиве в ключе `params` задаются необходимые для валидации значения, а в ключе `message` задается строка с сообщением об ошибке.

Вместо ключа `params` можно использовать ключ `@params`. В этом случае значения будут браться из полей формы, имя поля задается как `@имя`:

```
"field": {
    "equals": {
        "@params": "@foobar",
        "message": "Поле 'field' должно быть  равно полю 'foobar'"
    }
}
```

Если требуется задать два значения для правила, то их следует задавать как массив:

```
&rules=`{
    "field": {
        "lengthBetween": {
            "params": [10, 20],
            "message": "Длина должна быть от 10 до 20"
        }
    }
}`
```

Для правила `in` (и других правил, использующих массив) массив значений следует задавать следующим образом:

```
&rules=`{
    "field": {
        "in": {
            "params": [ [10, 20, 30] ],
            "message": "Значение поля field должно быть равно 10, 20 или 30"
        }
    }
}`
```

Это нужно, чтобы массив был передан в функцию одним аргументом.

Можно также использовать отрицание правил, если добавить перед именем правила восклицательный знак: `!numeric` - поле пройдет валидацию, если его значение не является числом.

Если нужно реализовать проверку только заполненных полей, то перед именем поля в списке правил нужно добавить восклицательный знак. В этом случае если значение поля пустое, правила будут проигнорированы.

```
{
    "имя поля 1": {
        "правило 1": "сообщение об ошибке",
        "правило 2": "сообщение об ошибке"
    },
    "имя поля 2": {
        "правило 1": "сообщение об ошибке",
        "правило 2": {
            "params": значение,
            "message": "сообщение об ошибке"
        }
    },
    "!имя поля 3":{
        "правило 1": "сообщение об ошибке"
    }
}
```

Стандартным классом валидации `\FormLister\Validator` предусмотрены правила:

| правило                               | описание                                                 | умолч     |
| ------------------------------------- | -------------------------------------------------------- | --------- |
| [required](#valid_required)           | поле заполнено                                           |           |
| [date](#valid_date)                   | значение поля является датой в заданном формате          |           |
| [min](#valid_min)                     | значение поля больше заданного или равно ему             |           |
| [max](#valid_max)                     | значение поля меньше заданного или равно ему             |           |
| [greater](#valid_greater)             | значение поля строго больше заданного                    |           |
| [less](#valid_less)                   | значение поля строго меньше заданного                    |           |
| [between](#valid_between)             | значение поля входит в диапазон (строго/не строго)       | не строго |
| [equals](#valid_equals)               | значение поля равно заданному                            |           |
| [in](#valid_in)                       | значение поля входит в заданный массив значений          |           |
| [alpha](#valid_alpha)                 | значение поля содержит только буквы                      |           |
| [numeric](#valid_numeric)             | значение поля содержит только цифры                      |           |
| [alphaNumeric](#valid_alphanumeric)   | значение поля содержит только буквы и цифры              |           |
| [slug](#valid_slug)                   | значение поля является частью url                        |           |
| [decimal](#valid_decimal)             | значение поля является десятичным числом                 |           |
| [phone](#valid_phone)                 | значение поля является номером телефона                  |           |
| [matches](#valid_matches)             | значение поля удовлетворяет регулярному выражению        |           |
| [url](#valid_url)                     | значение поля является ссылкой                           |           |
| [email](#valid_email)                 | значение поля является email-адресом                     |           |
| [length](#valid_length)               | длина значения поля равна заданному                      |           |
| [minLength](#valid_minlength)         | длина значения поля больше заданного (строго/не строго)  | не строго |
| [maxLength](#valid_maxlength)         | длина значения поля меньше заданного (строго/не строго)  | не строго |
| [lengthBetween](#valid_lengthbetween) | длина значения поля входит в диапазон (строго/не строго) | не строго |
| [minCount](#valid_mincount)           | размер массива больше заданного (строго/не строго)       | не строго |
| [maxCount](#valid_maxcount)           | размер массива меньше заданного (строго/не строго)       | не строго |
| [countBetween](#valid_countbetween)   | размер массива входит в диапазон (строго/не строго)      | не строго |
| [custom](#valid_custom)               | свои правила                                             |           |

### <a name="valid_required"></a> required

Поле заполнено.

```
"field":{
    "required": "Поле 'field' должно быть заполнено"
}
```

### <a name="valid_date"></a> date

Значение поля является датой в заданном формате (формат задается как для php-функции date).

```
"field": {
    "date": {
        "params": "d.m.Y",
        "message": "Поле 'field' должно быть в формате ДД.ММ.ГГГГ"
    }
}
```

### <a name="valid_min"></a> min

Значение поля больше заданного или равно ему.

```
"field":{
    "min": {
        "params": 10,
        "message": "Поле 'field' должно быть больше или равно 10"
    }
}
```

### <a name="valid_max"></a> max

Значение поля меньше заданного или равно ему.

```
"field":{
    "max": {
        "params": 20,
        "message": "Поле 'field' должно быть меньше или равно 20"
    }
}
```

### <a name="valid_greater"></a> greater

Значение поля строго больше заданного.

```
"field":{
    "greater": {
        "params": 20,
        "message": "Поле 'field' должно быть строго больше 20"
    }
}
```

### <a name="valid_less"></a> less

Значение поля строго меньше заданного.

```
"field":{
    "less": {
        "params": 10,
        "message": "Поле 'field' должно быть строго меньше 10"
    }
}
```

### <a name="valid_between"></a> between

Значение поля входит в диапазон (строго или не строго, по умолчанию - не строго).

```
"field":{
    "less": {
        "params": [10, 20],
        "message": "Поле 'field' должно быть больше или равно 10 и меньше или равно 20"
    }
},
"another_field":{
    "less": {
        "params": [10, 20, true],
        "message": "Поле 'another_field' должно быть строго больше 10 и строго меньше 20"
    }
}
```

### <a name="valid_equals"></a> equals

Значение поля равно заданному.

```
"field":{
    "less": {
        "params": 10,
        "message": "Поле 'field' должно равно 10"
    }
}
```

### <a name="valid_in"></a> in

Значение поля входит в заданный массив значений.

```
"field":{
    "in": {
        "params": [ ["a", "b", "c"] ]
        "message": "Поле 'field' должно быть равно a, b или c"
    }
}
```

### <a name="valid_alpha"></a> alpha

Значение поля содержит только буквы.

```
"field":{
    "alpha":"Поле 'field' должно содержать только буквы"
}
```

### <a name="valid_numeric"></a> numeric

Значение поля содержит только цифры.

```
"field":{
    "numeric":"Поле 'field' должно содержать только цифры"
}
```

### <a name="valid_alphanumeric"></a> alphaNumeric

Значение поля содержит только буквы и цифры.

```
"field":{
    "alphaNumeric":"Поле 'field' должно содержать только буквы и цифры"
}
```

### <a name="valid_slug"></a> slug

Значение поля является частью url.

?

### <a name="valid_decimal"></a> decimal

Значение поля является десятичным числом.

```
"field":{
    "decimal": "Поле 'field' должно быть десятичным числом"
}
```

### <a name="valid_phone"></a> phone

Значение поля является номером телефона.

```
"field":{
    "phone": "Поле 'field' должно быть корректным номером телефона"
}
```

### <a name="valid_matches"></a> matches

Значение поля удовлетворяет регулярному выражению.

```
"field":{
    "matches":{
        "params": "/[0-9]{6}/",
        "message": "Поле 'field' должно содержать 6 цифр"
    }
}
```

### <a name="valid_url"></a> url

Значение поля является ссылкой.

```
"field":{
    "url": "Поле 'field' должно быть ссылкой"
}
```

### <a name="valid_email"></a> email

Значение поля является email-адресом.

```
"field":{
    "email": "Поле 'field' должно быть адресом email"
}
```

### <a name="valid_length"></a> length

Длина значения поля равна заданному.

```
"field":{
    "length": {
        "params": 10,
        "message": "Поле 'field' должно содержать 10 символов"
    }
}
```

### <a name="valid_minlength"></a> minLength

Длина значения поля больше заданного (строго или не строго, по умолчанию - не строго).

```
"field":{
    "minLength": {
        "params": 10,
        "message": "Длина поля 'field' должна быть от 10 символов"
    }
},
"another_field":{
    "minLength": {
        "params": [10, true],
        "message": "Длина поля 'another_field' должна быть 10 или больше символов"
    }
}
```

### <a name="valid_maxlength"></a> maxLength

Длина значения поля меньше заданного (строго или не строго, по умолчанию - не строго).

```
"field":{
    "maxLength": {
        "params": 20,
        "message": "Длина поля 'field' должна быть до 20 символов"
    }
},
"another_field":{
    "maxLength": {
        "params": [20, true],
        "message": "Длина поля 'another_field' должна быть 20 или меньше символов"
    }
}
```

### <a name="valid_lengthbetween"></a> lengthBetween

Длина значения поля входит в диапазон (строго или не строго, по умолчанию - не строго);

```
"field":{
    "lengthBetween": {
        "params": [10, 20],
        "message": "Длина поля 'field' должна быть от 10 до 20 символов"
    }
},
"another_field":{
    "lengthBetween": {
        "params": [10, 20, true],
        "message": "Длина поля 'another_field' должна быть от 10 до 20 символов включительно"
    }
}
```

### <a name="valid_mincount"></a> minCount

Размер массива больше заданного (строго или не строго, по умолчанию - не строго);

```
"field":{
    "minCount": {
        "params": 10,
        "message": "В поле 'field' должно быть больше 10 элементов"
    }
},
"another_field":{
    "minLength": {
        "params": [10, true],
        "message": "В поле 'another_field' должно быть 10 или больше элементов"
    }
}
```

### <a name="valid_maxcount"></a> maxCount

Размер массива меньше заданного (строго или не строго, по умолчанию - не строго);

```
"field":{
    "maxCount": {
        "params": 10,
        "message": "В поле 'field' должно быть меньше 10 элементов"
    }
},
"another_field":{
    "maxCount": {
        "params": [10, true],
        "message": "В поле 'another_field' должно быть 10 или меньше элементов"
    }
}
```

### <a name="valid_countbetween"></a> countBetween

Размер массива входит в диапазон (строго или не строго, по умолчанию - не строго).

```
"field":{
    "countBetween": {
        "params": [10, 20],
        "message": "В поле 'field' должно быть от 10 до 20 элементов"
    }
},
"another_field":{
    "countBetween": {
        "params": [10, 20, true],
        "message": "В поле 'another_field' должно быть от 10 до 20 элементов включительно"
    }
}
```

### <a name="valid_custom"></a> custom

Предусмотрена также возможность использовать для валидации функции или статические методы загруженного класса:

```
&rules=`{
    "myfield":{
        "required":"Required field",
        "custom":{
            "function":"\\Namespace\\Classname::myCustomRule",
            "params":[10,20,30],
            "message":"Custom check failed"
        }
    }
}`
```

Метод должен принимать первым аргументом экземпляр контроллера из которого вызывается правило, вторым аргументом - значение проверяемого поля, далее - параметры передаваемые в ключе описания `params`:

```php
public static function myCustomRule($fl, $value, $a, $b, $c) {
    $result = $fl->getField('field1') == $a && $fl->getField('field2') == $b && $value == $c;
    return $result;
}
```

В примере правило будет пройдено, если значение поля `field1 = 10`, значение поля `field2 = 20`, а значение поля, к которму применяется правило, `= 30`.

Метод должен вернуть `true`, `false` или текст сообщения об ошибке (в этом случае можно не указывать `message` в списке правил).

В примере используется название правила `сustom`, но можно использовать любое название правила, которого нет в классе валидации. Таким образом можно использовать несколько правил данного типа.

## <a name="files"></a> Валидация файлов

Cтандартный валидатор файлов `\FormLister\FileValidator` поддерживает правила:

| правило        | описание                                                       | умолч     |
| -------------- | -------------------------------------------------------------- | --------- |
| `required`     | файлы успешно отправлены                                       |           |
| `allowed`      | расширение файла входит в заданный массив                      |           |
| `images`       | расширение файла jpg, jpeg, gif, png, bmp                      |           |
| `minSize`      | размер файла в килобайтах больше заданного (строго/не строго)  | не строго |
| `maxSize`      | размер файла в килобайтах меньше заданного (строго/не строго)  | не строго |
| `sizeBetween`  | размер файла в килобайтах входит в диапазон (строго/не строго) | не строго |
| `minCount`     | количество файлов больше заданного (строго/не строго)          | не строго |
| `maxCount`     | количество файлов меньше заданного (строго/не строго)          | не строго |
| `countBetween` | количество файлов входит в диапазон (строго/не строго)         | не строго |

## <a name="results"></a> Результаты валидации

Данные об ошибках хранятся в виде массива и могут быть получены вызовом метода `getFormData('errors')`:

```php
{
    "имя поля 1": {
        "имя нарушенного правила": "сообщение об ошибке"
    },
    "имя поля 2": {
        "имя нарушенного правила": "сообщение об ошибке"
    }
}
```

Для добавления данных в этот массив используется метод `addError(имя поля, имя правила, сообщение об ошибке)`. Таким образом, можно влиять на итоговый результат валидации, вручную добавляя записи в этот массив. Можно также объявить валидацию непройденной по умолчанию, вызвав метод `setValid(false)`.

В шаблонах результаты валидации для каждого поля выводятся с помощью плейсхолдера `[+имя поля.error+]`. Общий результат может быть выведен в плейсхолдер `[+form.messages+]`, который задается шаблоном `messagesTpl`. В свою очередь, в этом шаблоне можно использовать плейсхолдеры:

- `[+required+]` - сообщения о незаполенных полях;
- `[+errors+]` - сообщения о неверно заполненных полях.

Получить сообщения об ошибках для определенного поля можно с помощью метода `getErrorMessage(имя поля)`.
