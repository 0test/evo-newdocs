# Перенос сайта на Evolution CMS на новый домен

Пожалуйста, во избежание недоразумений, выполните эти действия только в том порядке, в котором они написаны.

**Заранее убедитесь, что версии PHP на старом и новом сервере совпадают!**

## Подготовительные действия

Переключите тип сайта на **HTTP**
`Конфигурация → Сайт → Тип сервера`

При смене домена всё равно придется выпустить новый сертификат.

Отключите редирект с **HTTP** на **HTTPS** в .htaccess, если он есть. Просто закомментируйте строки, поставив `#` в начале строки.

Рекомендуется очистить лог уведомлений `Конфигурация → Просмотр событий → Очистить протокол`

Затем очистите кэш `Верхнее меню → Инструменты → Очистить кэш`

Теперь разлогиньтесь в админке и **больше не открывайте сайт через браузер**.

## 0. Если вы переносите сайт с одного хостинга на другой

**Создайте архив файлов** сайта через контрольную панель хостинга. Убедитесь, что он содержит скрытые файлы и папки, такие, как .htaccess, .git, и пр. Создание архива средствами хостинга - предпочтительнее, чем самостоятельное сжатие через консоль сервера, если вы не знаете, как ей правильно пользоваться.

**Cоздайте бэкап базы данных** через phpmyadmin на хостинге или adminer. Как называется ваша БД можно посмотреть в файлах:

- Для версии 1.4.x `manager/includes/config.inc.php`
- Для версии 2.x и 3.x `core/config/database/connections/default.php`

  1.4.x

```
$dbase = '`my_database_name`';
```

3.x

```
'database' => env('DB_DATABASE', 'my_database_name'),
```

**Создайте БД на новом хостинге**, скопируйте параметры БД (не всегда, например, сервер баз данных находится на адресе localhost) и импортируйте дамп.

## 1. Перенос файлов сайта

**Всё ещё не заходите на сайт через браузер, пока я не разрешу.**

**Если вы переносите сайт с другого хостинга** - загрузите архив и распакуйте его на новом месте. Убедитесь, что структура файлов и папок совпадает после разархивации. Иногда при распаковке архивов всё содержимое оказывается в подпапке с названием архива. Переместите всё в корень сайта.

**Если вы просто переименовываете сайт** в новое имя, не меняя площадки - подключите другой домен сейчас или переименуйте сайт в контрольной панели хостинга.

## 3. Настройка нового соединения с БД

**Этот пункт нужен только если вы переносите сайт на другой хостинг.**

Для того, чтобы отредактировать параметры соединения, надо выставить файлам права 777. Иначе вы не сможете сохранить файл.

- Для версии 1.4.x `manager/includes/config.inc.php`
- Для версии 2.x и 3.x `core/config/database/connections/default.php`

Запишите туда новые реквизиты сервера БД, если вы переезжаете на новый хостинг, как минимум, адрес сервера, название базы, имя пользователя (обычно совпадает с названием базы) и пароль.

1.4.x

```php
$database_server   = 'database_server_address';
$database_user     = 'my_database_user';
$database_password = 'my_database_password';
$dbase             = '`my_database_name`';
```

3.x

```php
'host' => env('DB_HOST', 'database_server_address'),
'database' => env('DB_DATABASE', 'my_database_name'),
'username' => env('DB_USERNAME', 'my_database_user'),
'password' => env('DB_PASSWORD', 'my_database_password'),
```

## 4. Еще немного настроек

Не открывайте главную страницу сайта на новом месте, пока не настроите всё нужное в админке.

**Для версии 1.4.x** сотрите файл `assets/cache/siteHostnames.php`

Если вы верно выполнили предыдущие пункты - можно зайти в админку `new-site.tld/manager/`

Вы увидите предупреждение системы о том, что настройки изменились. Прямо в этом предупреждении уже есть ссылки на отдельные вкладки конфигурации. Также после сохранения настроек обновится и контрольная сумма файлов. Кнопку сейчас нажимать не надо.

![Предупреждение](/assets/images/008_move_conf_newerrors.png)

Идите по первой ссылке **путь для файл-браузера** или `Конфигурация → Вкладка Файл-менеджер` и нажмите кнопку сброс напротив поля **Путь для файл-менеджера:**

![Файл-менеджер](/assets/images/008_move_filemanager.png)

Далее соседняя вкладка `Файл-браузер` и нажмите кнопку сброс напротив поля **Путь к файлам:**

![Файл-браузер](/assets/images/008_move_filebrowser.png)

Далее можно сменить **Обратный адрес e-mail**, чтобы формы и данные паролей приходили с нового домена. Для 1.4.x это вкладка `Сайт`, для 3.x вкладка `Почта и шаблоны`

![Обратный адрес e-mail](/assets/images/008_move_emailsender.png)

### Наконец, нажимаем зеленую кнопку «Сохранить» в правом верхнем углу

И на версии 1.4.x мы увидим, что все предупреждения исчезли, кроме

![Права на файл](/assets/images/008_move_write.png)

Изменим права на файлы

- Для версии 1.4.x `manager/includes/config.inc.php`
- Для версии 2.x и 3.x `core/config/database/connections/default.php`

на **440**.

## 5. Конец

Очистите кэш `Верхнее меню → Инструменты → Очистить кэш`
и вот только теперь можно открыть главную страницу сайта на новом домене.

Далее, если это требуется, выпускаете сертификат, смените настройку **Тип сервера** с **HTTP** на **HTTPS**, убедитесь, что сайт корректно открывается по https и включите редирект в .htaccess обратно.
